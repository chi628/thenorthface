const badgeList = [
  {
    id: 'badge01',
    title: '野營大廚師',
    icon: './images/01-badge.webp',
    blackIcon: './images/01-N-badge.webp',
    layout: [
      './images/layout_logo/01-layout-1.png',
      './images/layout_logo/01-layout-2.png',
      './images/layout_logo/01-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/01-layout-1.png',
      './images/layout_no_logo/01-layout-2.png',
      './images/layout_no_logo/01-layout-3.png',
    ],
    shortDesc: '幫今晚的大廚拍張照吧',
  },
  {
    id: 'badge02',
    title: '水上玩咖',
    icon: './images/02-badge.webp',
    blackIcon: './images/02-N-badge.webp',
    layout: [
      './images/layout_logo/02-layout-1.png',
      './images/layout_logo/02-layout-2.png',
      './images/layout_logo/02-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/02-layout-1.png',
      './images/layout_no_logo/02-layout-2.png',
      './images/layout_no_logo/02-layout-3.png',
    ],
    shortDesc: '請分享你的SUP最佳POSE照',
  },
  {
    id: 'badge03',
    title: '戶外露營家',
    icon: './images/03-badge.webp',
    blackIcon: './images/03-N-badge.webp',
    layout: [
      './images/layout_logo/03-layout-1.png',
      './images/layout_logo/03-layout-2.png',
      './images/layout_logo/03-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/03-layout-1.png',
      './images/layout_no_logo/03-layout-2.png',
      './images/layout_no_logo/03-layout-3.png',
    ],
    shortDesc: '請分享營區帳篷照',
  },
  {
    id: 'badge04',
    title: '赤手登峰',
    icon: './images/04-badge.webp',
    blackIcon: './images/04-N-badge.webp',
    layout: [
      './images/layout_logo/04-layout-1.png',
      './images/layout_logo/04-layout-2.png',
      './images/layout_logo/04-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/04-layout-1.png',
      './images/layout_no_logo/04-layout-2.png',
      './images/layout_no_logo/04-layout-3.png',
    ],
    shortDesc: '請分享帥氣攀岩照',
  },
  {
    id: 'badge05',
    title: '熱血勇跑家',
    icon: './images/05-badge.webp',
    blackIcon: './images/05-N-badge.webp',
    layout: [
      './images/layout_logo/05-layout-1.png',
      './images/layout_logo/05-layout-2.png',
      './images/layout_logo/05-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/05-layout-1.png',
      './images/layout_no_logo/05-layout-2.png',
      './images/layout_no_logo/05-layout-3.png',
    ],
    shortDesc: '請在越野跑出發拱門拍照',
  },
  {
    id: 'badge06',
    title: '北面巔峰',
    icon: './images/06-badge.webp',
    blackIcon: './images/06-N-badge.webp',
    layout: [
      './images/layout_logo/06-layout-1.png',
      './images/layout_logo/06-layout-2.png',
      './images/layout_logo/06-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/06-layout-1.png',
      './images/layout_no_logo/06-layout-2.png',
      './images/layout_no_logo/06-layout-3.png',
    ],
    shortDesc: '分享穿上SUMMIT巔峰系列的照片',
  },
  {
    id: 'badge07',
    title: '晴空之上',
    icon: './images/07-badge.webp',
    blackIcon: './images/07-N-badge.webp',
    layout: [
      './images/layout_logo/07-layout-1.png',
      './images/layout_logo/07-layout-2.png',
      './images/layout_logo/07-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/07-layout-1.png',
      './images/layout_no_logo/07-layout-2.png',
      './images/layout_no_logo/07-layout-3.png',
    ],
    shortDesc: '拍下THE NORTH FACE高空氣球的蹤影',
  },
  {
    id: 'badge08',
    title: '山林對話',
    icon: './images/08-badge.webp',
    blackIcon: './images/08-N-badge.webp',
    layout: [
      './images/layout_logo/08-layout-1.png',
      './images/layout_logo/08-layout-2.png',
      './images/layout_logo/08-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/08-layout-1.png',
      './images/layout_no_logo/08-layout-2.png',
      './images/layout_no_logo/08-layout-3.png',
    ],
    shortDesc: '拍下一棵你最喜歡的樹',
  },
  {
    id: 'badge09',
    title: '手作體驗',
    icon: './images/09-badge.webp',
    blackIcon: './images/09-N-badge.webp',
    layout: [
      './images/layout_logo/09-layout-1.png',
      './images/layout_logo/09-layout-2.png',
      './images/layout_logo/09-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/09-layout-1.png',
      './images/layout_no_logo/09-layout-2.png',
      './images/layout_no_logo/09-layout-3.png',
    ],
    shortDesc: '分享你的北面療癒手作照片！',
  },
  {
    id: 'badge10',
    title: '電車騎士',
    icon: './images/10-badge.webp',
    blackIcon: './images/10-N-badge.webp',
    layout: [
      './images/layout_logo/10-layout-1.png',
      './images/layout_logo/10-layout-2.png',
      './images/layout_logo/10-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/10-layout-1.png',
      './images/layout_no_logo/10-layout-2.png',
      './images/layout_no_logo/10-layout-3.png',
    ],
    shortDesc: '出發兜風前拍個照是必須的吧！',
  },
  {
    id: 'badge11',
    title: '探險攝影師',
    icon: './images/11-badge.webp',
    blackIcon: './images/11-N-badge.webp',
    layout: [
      './images/layout_logo/11-layout-1.png',
      './images/layout_logo/11-layout-2.png',
      './images/layout_logo/11-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/11-layout-1.png',
      './images/layout_no_logo/11-layout-2.png',
      './images/layout_no_logo/11-layout-3.png',
    ],
    shortDesc: '與新品GoPro拍張照吧！',
  },
  {
    id: 'badge12',
    title: '精準導航員',
    icon: './images/12-badge.webp',
    blackIcon: './images/12-N-badge.webp',
    layout: [
      './images/layout_logo/12-layout-1.png',
      './images/layout_logo/12-layout-2.png',
      './images/layout_logo/12-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/12-layout-1.png',
      './images/layout_no_logo/12-layout-2.png',
      './images/layout_no_logo/12-layout-3.png',
    ],
    shortDesc: '與新品GPS智慧手錶拍張照吧！',
  },
]

badgeList.forEach(badge => {
  const imgList = [
    badge.icon,
    badge.blackIcon,
    badge.layout[0],
    badge.layout[1],
    badge.layout[2],
    badge.layout_noLogo[0],
    badge.layout_noLogo[1],
    badge.layout_noLogo[2],
  ]

  imgList.forEach(src => {
    const img = new Image()
    img.src = src
  })
})

let selectedBadge = ''

document.addEventListener('DOMContentLoaded', () => {
  const pageIndex = document.getElementById('pageIndex')
  const pageBadge = document.getElementById('pageBadge')
  const pageLayout = document.getElementById('page-layout')
  const pageUploadImg = document.getElementById('page-uploadImg')
  const pageShared = document.getElementById('page-share')

  const mainContainer = document.querySelector('.main-container')
  const badgeContainer = document.getElementById('badgeContainer')
  const lookMore = document.getElementById('look-more')
  const indexBadgeTitle = document.getElementById('index-badge-title')
  const indexJoinBtn = document.getElementById('index-join-btn')
  const layoutChooseBtn = document.getElementById('layout-choose-btn')

  if (mainContainer) {
    if (window.innerHeight < mainContainer.scrollHeight) {
      lookMore.style.display = 'flex'
      indexBadgeTitle.style.visibility = 'hidden'
    }

    mainContainer.addEventListener('scroll', () => {
      if (mainContainer.scrollTop > 0) {
        lookMore.style.display = 'none'
        indexBadgeTitle.style.visibility = 'visible'
      } else {
        lookMore.style.display = 'flex'
        indexBadgeTitle.style.visibility = 'hidden'
      }
    })
  }

  if (indexJoinBtn) {
    indexJoinBtn.addEventListener('click', () => {
      if (pageIndex && pageBadge) {
        pageIndex.style.display = 'none'
        badgeContainer.style.display = 'block'
        pageBadge.style.display = 'block'
      }
    })
  }

  const badge01Card = document.getElementById('badge01')
  const badge02Card = document.getElementById('badge02')
  const badge03Card = document.getElementById('badge03')
  const badge04Card = document.getElementById('badge04')
  const badge05Card = document.getElementById('badge05')
  const badge06Card = document.getElementById('badge06')
  const badge07Card = document.getElementById('badge07')
  const badge08Card = document.getElementById('badge08')
  const badge09Card = document.getElementById('badge09')
  const badge10Card = document.getElementById('badge10')
  const badge11Card = document.getElementById('badge11')
  const badge12Card = document.getElementById('badge12')

  if (badge01Card) {
    badge01Card.addEventListener('click', () => {
      appendSwiperSlides('badge01')
    })
  }

  if (badge02Card) {
    badge02Card.addEventListener('click', () => {
      appendSwiperSlides('badge02')
    })
  }

  if (badge03Card) {
    badge03Card.addEventListener('click', () => {
      appendSwiperSlides('badge03')
    })
  }

  if (badge04Card) {
    badge04Card.addEventListener('click', () => {
      appendSwiperSlides('badge04')
    })
  }

  if (badge05Card) {
    badge05Card.addEventListener('click', () => {
      appendSwiperSlides('badge05')
    })
  }

  if (badge06Card) {
    badge06Card.addEventListener('click', () => {
      appendSwiperSlides('badge06')
    })
  }

  if (badge07Card) {
    badge07Card.addEventListener('click', () => {
      appendSwiperSlides('badge07')
    })
  }

  if (badge08Card) {
    badge08Card.addEventListener('click', () => {
      appendSwiperSlides('badge08')
    })
  }

  if (badge09Card) {
    badge09Card.addEventListener('click', () => {
      appendSwiperSlides('badge09')
    })
  }

  if (badge10Card) {
    badge10Card.addEventListener('click', () => {
      appendSwiperSlides('badge10')
    })
  }

  if (badge11Card) {
    badge11Card.addEventListener('click', () => {
      appendSwiperSlides('badge11')
    })
  }

  if (badge12Card) {
    badge12Card.addEventListener('click', () => {
      appendSwiperSlides('badge12')
    })
  }

  const swiper = new Swiper('.layout-swiper', {
    slidesPerView: 1.3,
    centeredSlides: true,
    spaceBetween: 10,
    navigation: {
      nextEl: '.layout-swiper-next',
      prevEl: '.layout-swiper-prev',
    },
    on: {
      init() {
        const prevEl = document.querySelector('.layout-swiper-prev')

        if (prevEl) {
          prevEl.style.display = 'none'
        }
      },
      slideChange() {
        const prevEl = document.querySelector('.layout-swiper-prev')
        const nextEl = document.querySelector('.layout-swiper-next')

        if (this.activeIndex === 0) {
          prevEl.style.display = 'none'
        } else {
          prevEl.style.display = 'flex'
        }

        if (this.activeIndex === this.slides.length - 1) {
          nextEl.style.display = 'none'
        } else {
          nextEl.style.display = 'flex'
        }
      },
    },
  })

  let badgeObj
  if (layoutChooseBtn) {
    layoutChooseBtn.addEventListener('click', () => {
      console.log('index', swiper.activeIndex, badgeObj)
      pageLayout.style.display = 'none'
      pageUploadImg.style.display = 'block'

      switch (swiper.activeIndex) {
        case 0:
          current_photo_grid = photo_grid_1
          photo_grid_1.style.display = 'block'
          setBgImg(photo_grid_1)
          break
        case 1:
          current_photo_grid = photo_grid_2
          photo_grid_2.style.display = 'block'
          setBgImg(photo_grid_2)
          break
        case 2:
          current_photo_grid = photo_grid_3
          photo_grid_3.style.display = 'block'
          setBgImg(photo_grid_3)
          break
        default:
          break
      }
    })
  }

  function setBgImg(el) {
    const bgImgEl = el.querySelector('.bg-photo > img')
    const descContainer = document.getElementById('photo-short-desc')
    if (bgImgEl) {
      bgImgEl.src = badgeObj.layout[swiper.activeIndex]
    }

    if (descContainer) {
      descContainer.innerText = badgeObj.shortDesc
    }
  }

  // 處理上傳照片後，調整照片大小
  let current_photo_grid
  const photo_grid_1 = document.getElementById('photo-grid-1')
  const photo_grid_2 = document.getElementById('photo-grid-2')
  const photo_grid_3 = document.getElementById('photo-grid-3')

  const photo1 = document.getElementById('grid-1')
  const photo2Left = document.getElementById('grid-2-left')
  const photo2Right = document.getElementById('grid-2-right')
  const photo3Left = document.getElementById('grid-3-left')
  const photo3TopRight = document.getElementById('grid-3-top-right')
  const photo3BottomRight = document.getElementById('grid-3-bottom-right')

  if (photo1) {
    photo1.addEventListener('change', event => {
      cropImg(event, 'grid-1')
    })
  }

  if (photo2Left) {
    photo2Left.addEventListener('change', event => {
      cropImg(event, 'grid-2-left')
    })
  }

  if (photo2Right) {
    photo2Right.addEventListener('change', event => {
      cropImg(event, 'grid-2-right')
    })
  }

  if (photo3Left) {
    photo3Left.addEventListener('change', event => {
      cropImg(event, 'grid-3-left')
    })
  }

  if (photo3TopRight) {
    photo3TopRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-top-right')
    })
  }

  if (photo3BottomRight) {
    photo3BottomRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-bottom-right')
    })
  }

  const photoUploadBtn = document.getElementById('photo-upload-btn')

  let base64Url
  if (photoUploadBtn) {
    photoUploadBtn.addEventListener('click', () => {
      // if (cropper) {
      //   const croppedCanvas = cropper.getCroppedCanvas()
      //   const roundedCanvas = getCanvasImg(croppedCanvas)
      //   if (cropper.element) {
      //     cropper.element.src = roundedCanvas.toDataURL()
      //   }
      //   cropper.destroy()
      // }
      const bgImg = current_photo_grid.querySelector('.bg-photo > img')
      const canvas = document.createElement('canvas')
      const context = canvas.getContext('2d')
      const width = bgImg.getBoundingClientRect().width
      const height = bgImg.getBoundingClientRect().height
      canvas.width = width
      canvas.height = height
      context.imageSmoothingEnabled = true
      // 先畫拍立得底圖
      context.drawImage(bgImg, 0, 0, width, height)

      // 再找出拍立得上所有的 img
      const allImages = current_photo_grid.querySelectorAll('img')
      const filteredImages = Array.from(allImages).filter(img => {
        return !img.closest('.bg-photo')
      })

      filteredImages.forEach(img => {
        const xPos = img.getBoundingClientRect().x - bgImg.getBoundingClientRect().x
        const yPos = img.getBoundingClientRect().y - bgImg.getBoundingClientRect().y
        const _width = img.getBoundingClientRect().width
        const _height = img.getBoundingClientRect().height
        context.drawImage(img, xPos, yPos, _width, _height)
      })

      base64Url = canvas.toDataURL()
      pageUploadImg.style.display = 'none'
      pageShared.style.display = 'block'
      console.log('base 64', base64Url)
      document.getElementById('share-img').src = base64Url
    })
  }

  function appendSwiperSlides(id) {
    selectedBadge = id
    badgeObj = badgeList.find(badge => badge.id === id)
    const swiper = document.querySelector('.swiper-wrapper')

    console.log('obj', badgeObj)
    for (let i = 0; i < badgeObj.layout.length; i++) {
      const slide = document.createElement('div')
      slide.classList.add('swiper-slide')

      const imgEl = document.createElement('img')
      imgEl.src = badgeObj.layout[i]

      slide.appendChild(imgEl)
      swiper.appendChild(slide)
    }

    if (pageBadge && pageLayout) {
      pageBadge.style.display = 'none'
      pageLayout.style.display = 'block'
    }
  }

  let cropper

  function cropImg(evt, id) {
    if (cropper) {
      const croppedCanvas = cropper.getCroppedCanvas()
      const roundedCanvas = getCanvasImg(croppedCanvas)
      if (cropper.element) {
        cropper.element.src = roundedCanvas.toDataURL()
      }
      cropper.destroy()
    }
    const image = document.getElementById(`${id}-img`)
    const cropperBtn = document.getElementById(`${id}-cropper-btn`)
    let parentEl
    if (image) {
      parentEl = image.parentElement
    }
    let elWidth
    let eiHeight
    if (parentEl) {
      elWidth = parentEl.getBoundingClientRect().width
      eiHeight = parentEl.getBoundingClientRect().height
    }

    const file = evt.target.files[0]
    const reader = new FileReader()

    reader.onload = function (e) {
      image.src = e.target.result
      cropper = new Cropper(image, {
        dragMode: 'move',
        autoCropArea: 1,
        background: false,
        highlight: false,
        modal: false,
        cropBoxMovable: false,
        cropBoxResizable: false,
        minContainerWidth: elWidth,
        minContainerHeight: eiHeight,
        minCanvasWidth: elWidth,
        minCanvasHeight: eiHeight,
        minCropBoxWidth: elWidth,
        minCropBoxHeight: eiHeight,
        aspectRatio: elWidth / eiHeight,
      })
      console.log('crope', cropper)
      if (cropperBtn) {
        cropperBtn.style.display = 'flex'
        cropperBtn.addEventListener('click', () => {
          const croppedCanvas = cropper.getCroppedCanvas()
          const roundedCanvas = getCanvasImg(croppedCanvas)
          console.log('base64url', roundedCanvas.toDataURL())
          image.src = roundedCanvas.toDataURL()
          cropperBtn.style.display = 'none'
          cropper.destroy()
        })
      }
    }
    if (file) {
      reader.readAsDataURL(file)
    }
  }

  function getCanvasImg(sourceCanvas) {
    var canvas = document.createElement('canvas')
    var context = canvas.getContext('2d')
    var width = sourceCanvas.width
    var height = sourceCanvas.height

    canvas.width = width
    canvas.height = height
    context.imageSmoothingEnabled = true
    context.drawImage(sourceCanvas, 0, 0, width, height)
    return canvas
  }
})
