const badgeList = [
  {
    id: 'badge01',
    title: '野營大廚師',
    icon: './images/01-badge.webp',
    blackIcon: './images/01-N-badge.webp',
    layout: [
      './images/layout_logo/01-layout-1.png',
      './images/layout_logo/01-layout-2.png',
      './images/layout_logo/01-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/01-layout-1.png',
      './images/layout_no_logo/01-layout-2.png',
      './images/layout_no_logo/01-layout-3.png',
    ],
    shortDesc: '幫今晚的大廚拍張照吧',
  },
  {
    id: 'badge02',
    title: '水上玩咖',
    icon: './images/02-badge.webp',
    blackIcon: './images/02-N-badge.webp',
    layout: [
      './images/layout_logo/02-layout-1.png',
      './images/layout_logo/02-layout-2.png',
      './images/layout_logo/02-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/02-layout-1.png',
      './images/layout_no_logo/02-layout-2.png',
      './images/layout_no_logo/02-layout-3.png',
    ],
    shortDesc: '請分享SUP或獨木舟最佳POSE照',
  },
  {
    id: 'badge03',
    title: '戶外露營家',
    icon: './images/03-badge.webp',
    blackIcon: './images/03-N-badge.webp',
    layout: [
      './images/layout_logo/03-layout-1.png',
      './images/layout_logo/03-layout-2.png',
      './images/layout_logo/03-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/03-layout-1.png',
      './images/layout_no_logo/03-layout-2.png',
      './images/layout_no_logo/03-layout-3.png',
    ],
    shortDesc: '請分享營區帳篷照',
  },
  {
    id: 'badge04',
    title: '赤手登峰',
    icon: './images/04-badge.webp',
    blackIcon: './images/04-N-badge.webp',
    layout: [
      './images/layout_logo/04-layout-1.png',
      './images/layout_logo/04-layout-2.png',
      './images/layout_logo/04-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/04-layout-1.png',
      './images/layout_no_logo/04-layout-2.png',
      './images/layout_no_logo/04-layout-3.png',
    ],
    shortDesc: '請分享帥氣攀岩照',
  },
  {
    id: 'badge05',
    title: '熱血勇跑家',
    icon: './images/05-badge.webp',
    blackIcon: './images/05-N-badge.webp',
    layout: [
      './images/layout_logo/05-layout-1.png',
      './images/layout_logo/05-layout-2.png',
      './images/layout_logo/05-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/05-layout-1.png',
      './images/layout_no_logo/05-layout-2.png',
      './images/layout_no_logo/05-layout-3.png',
    ],
    shortDesc: '請在越野跑出發拱門拍照',
  },
  {
    id: 'badge06',
    title: '北面巔峰',
    icon: './images/06-badge.webp',
    blackIcon: './images/06-N-badge.webp',
    layout: [
      './images/layout_logo/06-layout-1.png',
      './images/layout_logo/06-layout-2.png',
      './images/layout_logo/06-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/06-layout-1.png',
      './images/layout_no_logo/06-layout-2.png',
      './images/layout_no_logo/06-layout-3.png',
    ],
    shortDesc: '分享穿上SUMMIT巔峰系列的照片',
  },
  {
    id: 'badge07',
    title: '晴空之上',
    icon: './images/07-badge.webp',
    blackIcon: './images/07-N-badge.webp',
    layout: [
      './images/layout_logo/07-layout-1.png',
      './images/layout_logo/07-layout-2.png',
      './images/layout_logo/07-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/07-layout-1.png',
      './images/layout_no_logo/07-layout-2.png',
      './images/layout_no_logo/07-layout-3.png',
    ],
    shortDesc: '拍下THE NORTH FACE高空氣球的蹤影',
  },
  {
    id: 'badge08',
    title: '山林對話',
    icon: './images/08-badge.webp',
    blackIcon: './images/08-N-badge.webp',
    layout: [
      './images/layout_logo/08-layout-1.png',
      './images/layout_logo/08-layout-2.png',
      './images/layout_logo/08-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/08-layout-1.png',
      './images/layout_no_logo/08-layout-2.png',
      './images/layout_no_logo/08-layout-3.png',
    ],
    shortDesc: '拍下一棵你最喜歡的樹',
  },
  {
    id: 'badge09',
    title: '手作體驗',
    icon: './images/09-badge.webp',
    blackIcon: './images/09-N-badge.webp',
    layout: [
      './images/layout_logo/09-layout-1.png',
      './images/layout_logo/09-layout-2.png',
      './images/layout_logo/09-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/09-layout-1.png',
      './images/layout_no_logo/09-layout-2.png',
      './images/layout_no_logo/09-layout-3.png',
    ],
    shortDesc: '分享你的北面療癒手作照片！',
  },
  {
    id: 'badge10',
    title: '電車騎士',
    icon: './images/10-badge.webp',
    blackIcon: './images/10-N-badge.webp',
    layout: [
      './images/layout_logo/10-layout-1.png',
      './images/layout_logo/10-layout-2.png',
      './images/layout_logo/10-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/10-layout-1.png',
      './images/layout_no_logo/10-layout-2.png',
      './images/layout_no_logo/10-layout-3.png',
    ],
    shortDesc: '出發兜風前拍個照是必須的吧！',
  },
  {
    id: 'badge11',
    title: '探險攝影師',
    icon: './images/11-badge.webp',
    blackIcon: './images/11-N-badge.webp',
    layout: [
      './images/layout_logo/11-layout-1.png',
      './images/layout_logo/11-layout-2.png',
      './images/layout_logo/11-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/11-layout-1.png',
      './images/layout_no_logo/11-layout-2.png',
      './images/layout_no_logo/11-layout-3.png',
    ],
    shortDesc: '與新品GoPro拍張照吧！',
  },
  {
    id: 'badge12',
    title: '精準導航員',
    icon: './images/12-badge.webp',
    blackIcon: './images/12-N-badge.webp',
    layout: [
      './images/layout_logo/12-layout-1.png',
      './images/layout_logo/12-layout-2.png',
      './images/layout_logo/12-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/12-layout-1.png',
      './images/layout_no_logo/12-layout-2.png',
      './images/layout_no_logo/12-layout-3.png',
    ],
    shortDesc: '與新品GPS智慧手錶拍張照吧！',
  },
]

badgeList.forEach(badge => {
  const imgList = [
    badge.icon,
    badge.blackIcon,
    badge.layout[0],
    badge.layout[1],
    badge.layout[2],
    badge.layout_noLogo[0],
    badge.layout_noLogo[1],
    badge.layout_noLogo[2],
  ]

  imgList.forEach(src => {
    const img = new Image()
    img.src = src
  })
})

let dataList = []
const fragment = new DocumentFragment()
async function fetchData() {
  try {
    const response = await fetch('./pic.json')
    if (!response.ok) {
      throw new Error('Network response was not ok')
    }
    const data = await response.json()
    dataList = data
  } catch (error) {
    console.error('error', error)
  }
}

let swiper
let badgeObj
let selectedBadge = ''
let currentLayout = 'pageIndex'
let current_photo_grid
let isDoneForm = false // 是否填過表單
let badgeCount = 0
let canChangeBottle = true

function setVH() {
  const vh = window.innerHeight
  document.documentElement.style.setProperty('--vh', `${vh}px`)
}

setVH()

window.addEventListener('resize', setVH)

document.addEventListener('DOMContentLoaded', async () => {
  console.log('v16')
  // document.getElementById('sold-out').addEventListener('click', () => {
  //   document.getElementById('exchanged-btn').style.display = 'none'
  //   document.getElementById('progressContainer').setAttribute('sold-out', '')
  // })
  await fetchData()
  const limit = 20
  dataList.forEach((data, index) => {
    const div = document.createElement('div')
    const img = document.createElement('img')
    img.src = data.pic
    div.classList.add('display-img')
    div.setAttribute('data-index', index)
    div.appendChild(img)
    div.addEventListener('click', debounce(openPhotoModal.bind(null, index)))
    fragment.appendChild(div)
  })

  const logo = document.getElementById('logo')
  const pageIndex = document.getElementById('pageIndex')
  const pageBadge = document.getElementById('pageBadge')
  const pageLayout = document.getElementById('page-layout')
  const pageUploadImg = document.getElementById('page-uploadImg')
  const pageShared = document.getElementById('page-share')
  const pageForm = document.getElementById('pageForm')
  const pageWaterfall = document.getElementById('pageWaterfall')
  const pageCoupon = document.getElementById('coupon-template')
  const pageResultModal = document.getElementById('result-modal')

  const mainContainer = document.querySelector('.main-container')
  const lookMore = document.getElementById('look-more')
  const indexBadgeTitle = document.getElementById('index-badge-title')
  const indexBadge = document.getElementById('index-badge')
  const indexJoinBtn = document.getElementById('index-join-btn')
  const layoutChooseBtn = document.getElementById('layout-choose-btn')

  // 點擊Logo回主頁
  if (logo) {
    logo.addEventListener('click', () => {
      nextPage('pageIndex')
    })
  }

  // 監聽首頁顯示 看更多
  if (mainContainer && indexBadge && lookMore) {
    const titleBottom = indexBadgeTitle.getBoundingClientRect().bottom
    let needHideTitle = false

    if (window.innerHeight - titleBottom < 110) {
      lookMore.style.display = 'flex'
      indexBadge.style.visibility = 'hidden'
      needHideTitle = true
    }

    document.addEventListener('scroll', () => {
      if (needHideTitle) {
        if (window.scrollY > 0) {
          lookMore.style.display = 'none'
          indexBadge.style.visibility = 'visible'
        } else {
          lookMore.style.display = 'flex'
          indexBadge.style.visibility = 'hidden'
        }
      }
    })
  }

  // 首頁
  // 1. 監聽立即參加按鈕
  if (indexJoinBtn) {
    indexJoinBtn.addEventListener(
      'click',
      debounce(() => {
        nextPage('pageBadge')
      })
    )
  }

  function appendPhoto() {
    const displayContainer = document.getElementById('display-container')
    const fragmentChildren = Array.from(fragment.childNodes)

    if (displayContainer && fragmentChildren.length) {
      const tmpFragment = new DocumentFragment()
      for (let i = 0; i < limit; i++) {
        if (fragmentChildren[i]) {
          tmpFragment.appendChild(fragmentChildren[i])
        }
      }
      displayContainer.appendChild(tmpFragment)
    }
  }
  // 2. 監聽精彩直擊按鈕
  const waterfallBtn = document.getElementById('waterfall')
  if (waterfallBtn) {
    waterfallBtn.addEventListener(
      'click',
      debounce(() => {
        nextPage('pageWaterfall')
        appendPhoto()

        const bottomEl = document.getElementById('bottom-more')
        let needCallAgain = false
        const observer = new IntersectionObserver(
          entries => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                needCallAgain = true
                if (entry.target === bottomEl) {
                  appendPhoto()
                  setTimeout(() => {
                    if (needCallAgain) {
                      appendPhoto()
                    }
                  }, 500)
                }
              } else {
                needCallAgain = false
              }
            })
          },
          {
            rootMargin: '0px',
            threshold: 0,
          }
        )
        bottomEl && observer.observe(bottomEl)
      })
    )
  }
  // 精彩直擊頁面
  // 1. 監聽立即參加按鈕
  const waterfallJoinBtn = document.getElementById('waterfall-join-btn')
  if (waterfallJoinBtn) {
    waterfallJoinBtn.addEventListener(
      'click',
      debounce(() => {
        nextPage('pageBadge')
      })
    )
  }
  // 2. 監聽每個作品彈窗是否被點擊 > 點擊後關閉彈窗
  const photoModal = document.getElementById('photo-modal')
  if (photoModal) {
    photoModal.addEventListener(
      'click',
      debounce(() => {
        photoModal.style.display = 'none'
      })
    )
  }

  // 選擇徽章頁
  // 1. 監聽點選的徽章
  document.querySelectorAll('.badge-card').forEach(card => {
    const id = card.getAttribute('id')

    card.addEventListener(
      'click',
      debounce(() => {
        selectedBadge = id
        badgeObj = badgeList.find(badge => badge.id === id)

        document.querySelectorAll('.swiper-slide > img').forEach((slide, index) => {
          slide.src = badgeObj.layout[index]
          slide.alt = badgeObj.title
        })

        if (swiper) {
          swiper.destroy(true, true)
        }

        console.log('swiper', swiper)

        swiper = new Swiper('.layout-swiper', {
          initialSlide: 0,
          slidesPerView: 1.3,
          centeredSlides: true,
          spaceBetween: 10,
          navigation: {
            nextEl: '.layout-swiper-next',
            prevEl: '.layout-swiper-prev',
          },
          on: {
            init() {
              console.log('init')
              const prevEl = document.querySelector('.layout-swiper-prev')

              if (prevEl) {
                prevEl.style.display = 'none'
              }
            },
            slideChange() {
              const prevEl = document.querySelector('.layout-swiper-prev')
              const nextEl = document.querySelector('.layout-swiper-next')

              if (this.activeIndex === 0) {
                prevEl.style.display = 'none'
              } else {
                prevEl.style.display = 'flex'
              }

              if (this.activeIndex === this.slides.length - 1) {
                nextEl.style.display = 'none'
              } else {
                nextEl.style.display = 'flex'
              }
            },
          },
        })

        nextPage('pageLayout')
      })
    )
  })
  // 2. 手作體驗-綁定領取
  const receiveBtn = document.getElementById('receive-btn')
  if (receiveBtn) {
    receiveBtn.addEventListener(
      'click',
      debounce(() => {
        const progessContainer = document.querySelector('.progress-container')
        const step = progessContainer.getAttribute('step')
        if (parseInt(step) >= 3) {
          window.open('https://maac.io/2LRej')
          receiveBtn.style.display = 'none'
          showCouponBtn.style.display = 'flex'
        }
      })
    )
  }
  // 3. 手作體驗-前往領取
  const showCouponBtn = document.getElementById('show-coupon-btn')
  if (showCouponBtn) {
    showCouponBtn.addEventListener(
      'click',
      debounce(() => {
        nextPage('pageCoupon')
      })
    )
  }
  // 兌換券
  const couponExchangeBtn = document.getElementById('coupon-exchange-btn')
  const couponModal = document.getElementById('coupon-modal-template')
  if (couponExchangeBtn) {
    couponExchangeBtn.addEventListener(
      'click',
      debounce(() => {
        if (canChangeBottle) {
          if (couponModal) {
            couponModal.style.display = 'block'
          }
        }
      })
    )
  }

  const couponModalExchange = document.getElementById('coupon-modal-exchange')
  const cancelCouponModalBtn = document.getElementById('coupon-modal-cancel')
  const coupontModalInput = document.getElementById('coupon-modal-input')
  const bottleCoupon = document.getElementById('bottle-coupon')

  if (couponModalExchange) {
    couponModalExchange.addEventListener(
      'click',
      debounce(() => {
        if (coupontModalInput.value) {
          couponModal.style.display = 'none'
          if (bottleCoupon) {
            // 已兌換樣式
            bottleCoupon.classList.add('disabled')
            canChangeBottle = false
            showCouponBtn.style.display = 'none'
            document.getElementById('progressContainer').setAttribute('exchanged', '')
          }
        }
      })
    )
  }

  if (cancelCouponModalBtn) {
    cancelCouponModalBtn.addEventListener(
      'click',
      debounce(() => {
        couponModal.style.display = 'none'
      })
    )
  }

  // 選擇版型頁
  // 1. 監聽確定按鈕
  if (layoutChooseBtn) {
    layoutChooseBtn.addEventListener(
      'click',
      debounce(() => {
        nextPage('pageUploadImg')
        resetUploadImg()
        console.log('swiper', swiper.activeIndex)
        switch (swiper.activeIndex) {
          case 0:
            current_photo_grid = photo_grid_1
            photo_grid_1.style.display = 'block'
            setBgImg(photo_grid_1)
            break
          case 1:
            current_photo_grid = photo_grid_2
            photo_grid_2.style.display = 'block'
            setBgImg(photo_grid_2)
            break
          case 2:
            current_photo_grid = photo_grid_3
            photo_grid_3.style.display = 'block'
            setBgImg(photo_grid_3)
            break
          default:
            break
        }
      })
    )
  }
  function resetUploadImg() {
    photo_grid_1.style.display = 'none'
    photo_grid_2.style.display = 'none'
    photo_grid_3.style.display = 'none'

    photo_grid_1.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
    photo_grid_2.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
    photo_grid_3.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
    if (photo1Cropper) {
      photo1Cropper.destroy()
    }
    if (photo2LeftCropper) {
      photo2LeftCropper.destroy()
    }
    if (photo2RightCropper) {
      photo2RightCropper.destroy()
    }
    if (photo3LeftCropper) {
      photo3LeftCropper.destroy()
    }
    if (photo3TopRightCropper) {
      photo3TopRightCropper.destroy()
    }
    if (photo3BottomRightCropper) {
      photo3BottomRightCropper.destroy()
    }

    photo1.value = ''
    photo2Left.value = ''
    photo2Right.value = ''
    photo3Left.value = ''
    photo3TopRight.value = ''
    photo3BottomRight.value = ''
  }

  // 選擇照片頁
  const photo_grid_1 = document.getElementById('photo-grid-1') // 單張照片拍立得
  const photo_grid_2 = document.getElementById('photo-grid-2') // 兩張照片拍立得
  const photo_grid_3 = document.getElementById('photo-grid-3') // 三張照片拍立得
  // 取得每張拍立得的 img dom
  const photo1 = document.getElementById('grid-1')
  const photo2Left = document.getElementById('grid-2-left')
  const photo2Right = document.getElementById('grid-2-right')
  const photo3Left = document.getElementById('grid-3-left')
  const photo3TopRight = document.getElementById('grid-3-top-right')
  const photo3BottomRight = document.getElementById('grid-3-bottom-right')
  // 每個 img 建立自己的 cropper instance
  let photo1Cropper
  let photo2LeftCropper
  let photo2RightCropper
  let photo3LeftCropper
  let photo3TopRightCropper
  let photo3BottomRightCropper

  // 繪製上傳相片的拍立得底圖
  function setBgImg(el) {
    const bgImgEl = el.querySelector('.bg-photo > img')
    const descContainer = document.getElementById('photo-short-desc')
    if (bgImgEl) {
      bgImgEl.src = badgeObj.layout[swiper.activeIndex]
    }

    if (descContainer) {
      descContainer.innerText = badgeObj.shortDesc
    }
  }

  if (photo1) {
    photo1.addEventListener('change', event => {
      cropImg(event, 'grid-1')
    })
  }
  if (photo2Left) {
    photo2Left.addEventListener('change', event => {
      cropImg(event, 'grid-2-left')
    })
  }
  if (photo2Right) {
    photo2Right.addEventListener('change', event => {
      cropImg(event, 'grid-2-right')
    })
  }
  if (photo3Left) {
    photo3Left.addEventListener('change', event => {
      cropImg(event, 'grid-3-left')
    })
  }
  if (photo3TopRight) {
    photo3TopRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-top-right')
    })
  }
  if (photo3BottomRight) {
    photo3BottomRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-bottom-right')
    })
  }
  function cropImg(evt, id) {
    const image = document.getElementById(`${id}-img`)
    const cropperBtn = document.getElementById(`${id}-cropper-btn`)
    let parentEl
    if (image) {
      parentEl = image.parentElement
    }
    let elWidth
    let eiHeight
    if (parentEl) {
      elWidth = parentEl.getBoundingClientRect().width
      eiHeight = parentEl.getBoundingClientRect().height
    }

    const file = evt.target.files[0]
    const reader = new FileReader()

    reader.onload = function (e) {
      image.src = e.target.result
      const cropper = new Cropper(image, {
        viewMode: 0,
        dragMode: 'move',
        checkOrientation: false,
        background: false,
        highlight: false,
        modal: false,
        cropBoxMovable: false,
        cropBoxResizable: false,
        minContainerWidth: elWidth,
        minContainerHeight: eiHeight,
        ready() {
          // this.cropper.setCanvasData({
          //   width: elWidth,
          //   height: eiHeight,
          // })
          this.cropper.setCropBoxData({
            width: elWidth,
            height: eiHeight,
          })
          this.cropper.zoom(0.3)
        },
      })

      if (id === 'grid-1') {
        photo1Cropper = cropper
      } else if (id === 'grid-2-left') {
        photo2LeftCropper = cropper
      } else if (id === 'grid-2-right') {
        photo2RightCropper = cropper
      } else if (id === 'grid-3-left') {
        photo3LeftCropper = cropper
      } else if (id === 'grid-3-top-right') {
        photo3TopRightCropper = cropper
      } else if (id === 'grid-3-bottom-right') {
        photo3BottomRightCropper = cropper
      }

      if (cropperBtn) {
        cropperBtn.addEventListener('click', () => {
          let croppedCanvas
          if (id === 'grid-1') {
            croppedCanvas = photo1Cropper.getCroppedCanvas()
          } else if (id === 'grid-2-left') {
            croppedCanvas = photo2LeftCropper.getCroppedCanvas()
          } else if (id === 'grid-2-right') {
            croppedCanvas = photo2RightCropper.getCroppedCanvas()
          } else if (id === 'grid-3-left') {
            croppedCanvas = photo3LeftCropper.getCroppedCanvas()
          } else if (id === 'grid-3-top-right') {
            croppedCanvas = photo3TopRightCropper.getCroppedCanvas()
          } else if (id === 'grid-3-bottom-right') {
            croppedCanvas = photo3BottomRightCropper.getCroppedCanvas()
          }

          const roundedCanvas = getCanvasImg(croppedCanvas)
          image.src = roundedCanvas.toDataURL()

          if (id === 'grid-1') {
            photo1Cropper.destroy()
          } else if (id === 'grid-2-left') {
            photo2LeftCropper.destroy()
          } else if (id === 'grid-2-right') {
            photo2RightCropper.destroy()
          } else if (id === 'grid-3-left') {
            photo3LeftCropper.destroy()
          } else if (id === 'grid-3-top-right') {
            photo3TopRightCropper.destroy()
          } else if (id === 'grid-3-bottom-right') {
            photo3BottomRightCropper.destroy()
          }
        })
      }
    }
    if (file) {
      reader.readAsDataURL(file)
    }
  }

  // 監聽確定照片按鈕 >> 組合照片，並轉成 base64
  const photoUploadBtn = document.getElementById('photo-upload-btn')
  let base64Url
  let base64Url_nologo
  if (photoUploadBtn) {
    photoUploadBtn.addEventListener(
      'click',
      debounce(async () => {
        photoUploadBtn.style.display = 'none'
        switch (swiper.activeIndex) {
          case 0:
            const btn = document.getElementById(`grid-1-cropper-btn`)
            btn.click()
            await new Promise(resolve => {
              const wait = setInterval(() => {
                clearInterval(wait)
                resolve()
              }, 100)
            })
            break
          case 1:
            document.getElementById('grid-2-left-cropper-btn').click()
            document.getElementById('grid-2-right-cropper-btn').click()
            await new Promise(resolve => {
              const wait = setInterval(() => {
                clearInterval(wait)
                resolve()
              }, 200)
            })
            break
          case 2:
            document.getElementById('grid-3-left-cropper-btn').click()
            document.getElementById('grid-3-top-right-cropper-btn').click()
            document.getElementById('grid-3-bottom-right-cropper-btn').click()
            await new Promise(resolve => {
              const wait = setInterval(() => {
                clearInterval(wait)
                resolve()
              }, 300)
            })
            break
          default:
            break
        }
        const bgImg = current_photo_grid.querySelector('.bg-photo > img')
        const width = bgImg.getBoundingClientRect().width
        const height = bgImg.getBoundingClientRect().height

        const noLogoImg = document.createElement('img')
        noLogoImg.src = badgeObj.layout_noLogo[swiper.activeIndex]

        const canvas = document.createElement('canvas')
        const context = canvas.getContext('2d')
        canvas.width = width
        canvas.height = height
        context.imageSmoothingEnabled = true

        const canvas2 = document.createElement('canvas')
        const cxt = canvas2.getContext('2d')
        canvas2.width = width
        canvas2.height = height
        cxt.imageSmoothingEnabled = true

        await new Promise(resolve => {
          let wait2 = setInterval(() => {
            clearInterval(wait2)
            resolve()
          }, 200)
        })

        // 先畫拍立得底圖
        context.drawImage(bgImg, 0, 0, width, height)
        cxt.drawImage(noLogoImg, 0, 0, width, height)
        // 再找出拍立得上所有的 img
        const allImages = current_photo_grid.querySelectorAll('img')
        const filteredImages = Array.from(allImages).filter(img => {
          return !img.closest('.bg-photo')
        })
        filteredImages.forEach(img => {
          const xPos = img.getBoundingClientRect().x - bgImg.getBoundingClientRect().x
          const yPos = img.getBoundingClientRect().y - bgImg.getBoundingClientRect().y
          const _width = img.getBoundingClientRect().width
          const _height = img.getBoundingClientRect().height
          context.drawImage(img, xPos, yPos, _width, _height)
          cxt.drawImage(img, xPos, yPos, _width, _height)
        })
        base64Url = canvas.toDataURL()
        base64Url_nologo = canvas2.toDataURL()

        nextPage('pageShared')
        document.getElementById('share-img').src = base64Url
        // document.getElementById('photo-nologo').src = base64Url_nologo
        photoUploadBtn.style.display = 'flex'
      })
    )
  }

  // 分享好友頁面
  // 1. 監聽分享好友按鈕
  // > 沒填寫過表單才會前往表單頁
  // > 按下按鈕後，視同搜集徽章
  const shareBtn = document.getElementById('share-btn')
  if (shareBtn) {
    shareBtn.addEventListener('click', () => {
      badgeTaskDone()
      if (isDoneForm) {
        nextPage('pageResultModal')
      } else {
        nextPage('pageForm')
      }
    })
  }
  function badgeTaskDone() {
    const taskCard = document.getElementById(selectedBadge)
    if (taskCard) {
      taskCard.querySelector('img').src = badgeObj.icon
    }
    // 是否要阻擋上傳同份徽章
    badgeCount++
    const progressContainer = document.getElementById('progressContainer')
    if (progressContainer) {
      progressContainer.setAttribute('step', badgeCount)
    }
  }

  // 填寫資料頁面
  // 1.監聽確認送出按鈕 >> 送出前檢查 input 的值
  const submitFormBtn = document.getElementById('submit-form-btn')
  if (submitFormBtn) {
    submitFormBtn.addEventListener('click', () => {
      // 傳送資料
      const errorHint = document.getElementById('error-hint')
      const inputName = document.getElementById('form-input-name')
      const inputTel = document.getElementById('form-input-tel')
      const telPattern = /09\d{2}(\d{6}|-\d{3}-\d{3})/
      if (!telPattern.test(inputTel.value)) {
        errorHint.innerText = '請輸入正確號碼格式'
      }
      if (!inputName.value) {
        errorHint.innerText = '請輸入資料'
      }
      const memberCheck = document.getElementById('member')
      const privacyCheck = document.getElementById('privacy')
      if (!memberCheck.checked || !privacyCheck.checked) {
        errorHint.innerText = '請同意勾選資料使用或隱私權政策'
      }

      if (
        inputName.value &&
        inputTel.value &&
        telPattern.test(inputTel.value) &&
        memberCheck.checked &&
        privacyCheck.checked
      ) {
        // 假定已經填寫過資料
        isDoneForm = true
        nextPage('pageResultModal')
      }
      // else {
      //   errorHint.innerText = '請輸入資料'
      // }
    })
  }

  // 監聽結果彈窗按鈕
  const resultModalBtn = document.getElementById('result-modal-btn')
  if (resultModalBtn) {
    resultModalBtn.addEventListener('click', () => {
      nextPage('pageIndex')
    })
  }

  const backBtn = document.getElementById('back-btn')
  backBtn.addEventListener('click', () => {
    switch (currentLayout) {
      case 'pageBadge':
        nextPage('pageIndex')
        break
      case 'pageCoupon':
        nextPage('pageBadge')
        break
      case 'pageLayout':
        nextPage('pageBadge')
        break
      case 'pageUploadImg':
        nextPage('pageLayout')
        break
      case 'pageShared':
        nextPage('pageUploadImg')
        break
      case 'pageForm':
        nextPage('pageShared')
        break
      case 'pageWaterfall':
        mainContainer.classList.add('reverse-animated')
        nextPage('pageIndex')
        mainContainer.style.left = '-80%'
        setTimeout(() => {
          mainContainer.style.left = 0
          mainContainer.classList.remove('reverse-animated')
        }, 300)
        break
      default:
        break
    }
  })

  function nextPage(page) {
    const pageList = [
      pageIndex,
      pageBadge,
      pageLayout,
      pageUploadImg,
      pageShared,
      pageForm,
      pageWaterfall,
      pageCoupon,
      pageResultModal,
    ]

    pageList.forEach(page => {
      page.style.display = 'none'
    })
    switch (page) {
      case 'pageIndex':
        pageIndex.style.display = 'block'
        currentLayout = 'pageIndex'
        break
      case 'pageBadge':
        pageBadge.style.display = 'block'
        currentLayout = 'pageBadge'
        break
      case 'pageCoupon':
        pageCoupon.style.display = 'block'
        currentLayout = 'pageCoupon'
        break
      case 'pageLayout':
        pageLayout.style.display = 'block'
        currentLayout = 'pageLayout'
        break
      case 'pageUploadImg':
        pageUploadImg.style.display = 'block'
        currentLayout = 'pageUploadImg'
        break
      case 'pageShared':
        pageShared.style.display = 'block'
        currentLayout = 'pageShared'
        break
      case 'pageForm':
        pageForm.style.display = 'block'
        currentLayout = 'pageForm'
        break
      case 'pageWaterfall':
        mainContainer.classList.add('animated')
        pageWaterfall.style.display = 'block'
        currentLayout = 'pageWaterfall'
        break
      case 'pageResultModal':
        if (isDoneForm) {
          pageResultModal.style.display = 'block'
          pageResultModal.classList.add('share')
        } else {
          pageResultModal.style.display = 'block'
        }
        currentLayout = 'pageResultModal'
        break
      default:
        break
    }

    if (['pageWaterfall', 'pageForm'].includes(page)) {
      mainContainer.setAttribute('bg', 'right')
      if (page === 'pageWaterfall') {
        mainContainer.style.left = '100%'
        setTimeout(() => {
          mainContainer.style.left = '0'
          mainContainer.classList.remove('animated')
        }, 300)
      }
    } else if (page === 'pageIndex') {
      mainContainer.removeAttribute('bg')
    } else {
      mainContainer.setAttribute('bg', 'mask')
    }
    window.scrollTo(0, 0)
  }

  function openPhotoModal(index, event) {
    const avatar = document.getElementById('user-avatar')
    const name = document.getElementById('user-name')
    const photo = document.getElementById('user-photo')

    if (avatar) {
      avatar.src = dataList[index].displaypic
    }

    if (name) {
      name.innerText = dataList[index].displayname
    }

    if (photo) {
      photo.src = dataList[index].pic
    }

    if (photoModal) {
      photoModal.style.display = 'flex'
    }
  }

  function getCanvasImg(sourceCanvas) {
    var canvas = document.createElement('canvas')
    var context = canvas.getContext('2d')
    var width = sourceCanvas.width
    var height = sourceCanvas.height

    canvas.width = width
    canvas.height = height
    context.imageSmoothingEnabled = true
    context.drawImage(sourceCanvas, 0, 0, width, height)
    return canvas
  }

  // document.getElementById('nologo-btn').addEventListener('click', () => {
  //   document.getElementById('nologo-modal').style.display = 'block'

  //   document.getElementById('nologo-modal').addEventListener('click', () => {
  //     document.getElementById('nologo-modal').style.display = 'none'
  //   })
  // })

  function debounce(func, limit = 200) {
    let timer = null
    return function () {
      const args = arguments
      clearTimeout(timer)
      timer = setTimeout(() => {
        // @ts-ignore
        func.apply(this, args)
      }, limit)
    }
  }
})
