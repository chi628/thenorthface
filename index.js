const badgeList = [
  {
    id: 'badge01',
    title: '野營大廚師',
    icon: './images/01-badge.webp',
    blackIcon: './images/01-N-badge.webp',
    layout: [
      './images/layout_logo/01-layout-1.png',
      './images/layout_logo/01-layout-2.png',
      './images/layout_logo/01-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/01-layout-1.png',
      './images/layout_no_logo/01-layout-2.png',
      './images/layout_no_logo/01-layout-3.png',
    ],
    shortDesc: '幫今晚的大廚拍張照吧',
  },
  {
    id: 'badge02',
    title: '水上玩咖',
    icon: './images/02-badge.webp',
    blackIcon: './images/02-N-badge.webp',
    layout: [
      './images/layout_logo/02-layout-1.png',
      './images/layout_logo/02-layout-2.png',
      './images/layout_logo/02-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/02-layout-1.png',
      './images/layout_no_logo/02-layout-2.png',
      './images/layout_no_logo/02-layout-3.png',
    ],
    shortDesc: '請分享你的SUP最佳POSE照',
  },
  {
    id: 'badge03',
    title: '戶外露營家',
    icon: './images/03-badge.webp',
    blackIcon: './images/03-N-badge.webp',
    layout: [
      './images/layout_logo/03-layout-1.png',
      './images/layout_logo/03-layout-2.png',
      './images/layout_logo/03-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/03-layout-1.png',
      './images/layout_no_logo/03-layout-2.png',
      './images/layout_no_logo/03-layout-3.png',
    ],
    shortDesc: '請分享營區帳篷照',
  },
  {
    id: 'badge04',
    title: '赤手登峰',
    icon: './images/04-badge.webp',
    blackIcon: './images/04-N-badge.webp',
    layout: [
      './images/layout_logo/04-layout-1.png',
      './images/layout_logo/04-layout-2.png',
      './images/layout_logo/04-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/04-layout-1.png',
      './images/layout_no_logo/04-layout-2.png',
      './images/layout_no_logo/04-layout-3.png',
    ],
    shortDesc: '請分享帥氣攀岩照',
  },
  {
    id: 'badge05',
    title: '熱血勇跑家',
    icon: './images/05-badge.webp',
    blackIcon: './images/05-N-badge.webp',
    layout: [
      './images/layout_logo/05-layout-1.png',
      './images/layout_logo/05-layout-2.png',
      './images/layout_logo/05-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/05-layout-1.png',
      './images/layout_no_logo/05-layout-2.png',
      './images/layout_no_logo/05-layout-3.png',
    ],
    shortDesc: '請在越野跑出發拱門拍照',
  },
  {
    id: 'badge06',
    title: '北面巔峰',
    icon: './images/06-badge.webp',
    blackIcon: './images/06-N-badge.webp',
    layout: [
      './images/layout_logo/06-layout-1.png',
      './images/layout_logo/06-layout-2.png',
      './images/layout_logo/06-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/06-layout-1.png',
      './images/layout_no_logo/06-layout-2.png',
      './images/layout_no_logo/06-layout-3.png',
    ],
    shortDesc: '分享穿上SUMMIT巔峰系列的照片',
  },
  {
    id: 'badge07',
    title: '晴空之上',
    icon: './images/07-badge.webp',
    blackIcon: './images/07-N-badge.webp',
    layout: [
      './images/layout_logo/07-layout-1.png',
      './images/layout_logo/07-layout-2.png',
      './images/layout_logo/07-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/07-layout-1.png',
      './images/layout_no_logo/07-layout-2.png',
      './images/layout_no_logo/07-layout-3.png',
    ],
    shortDesc: '拍下THE NORTH FACE高空氣球的蹤影',
  },
  {
    id: 'badge08',
    title: '山林對話',
    icon: './images/08-badge.webp',
    blackIcon: './images/08-N-badge.webp',
    layout: [
      './images/layout_logo/08-layout-1.png',
      './images/layout_logo/08-layout-2.png',
      './images/layout_logo/08-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/08-layout-1.png',
      './images/layout_no_logo/08-layout-2.png',
      './images/layout_no_logo/08-layout-3.png',
    ],
    shortDesc: '拍下一棵你最喜歡的樹',
  },
  {
    id: 'badge09',
    title: '手作體驗',
    icon: './images/09-badge.webp',
    blackIcon: './images/09-N-badge.webp',
    layout: [
      './images/layout_logo/09-layout-1.png',
      './images/layout_logo/09-layout-2.png',
      './images/layout_logo/09-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/09-layout-1.png',
      './images/layout_no_logo/09-layout-2.png',
      './images/layout_no_logo/09-layout-3.png',
    ],
    shortDesc: '分享你的北面療癒手作照片！',
  },
  {
    id: 'badge10',
    title: '電車騎士',
    icon: './images/10-badge.webp',
    blackIcon: './images/10-N-badge.webp',
    layout: [
      './images/layout_logo/10-layout-1.png',
      './images/layout_logo/10-layout-2.png',
      './images/layout_logo/10-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/10-layout-1.png',
      './images/layout_no_logo/10-layout-2.png',
      './images/layout_no_logo/10-layout-3.png',
    ],
    shortDesc: '出發兜風前拍個照是必須的吧！',
  },
  {
    id: 'badge11',
    title: '探險攝影師',
    icon: './images/11-badge.webp',
    blackIcon: './images/11-N-badge.webp',
    layout: [
      './images/layout_logo/11-layout-1.png',
      './images/layout_logo/11-layout-2.png',
      './images/layout_logo/11-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/11-layout-1.png',
      './images/layout_no_logo/11-layout-2.png',
      './images/layout_no_logo/11-layout-3.png',
    ],
    shortDesc: '與新品GoPro拍張照吧！',
  },
  {
    id: 'badge12',
    title: '精準導航員',
    icon: './images/12-badge.webp',
    blackIcon: './images/12-N-badge.webp',
    layout: [
      './images/layout_logo/12-layout-1.png',
      './images/layout_logo/12-layout-2.png',
      './images/layout_logo/12-layout-3.png',
    ],
    layout_noLogo: [
      './images/layout_no_logo/12-layout-1.png',
      './images/layout_no_logo/12-layout-2.png',
      './images/layout_no_logo/12-layout-3.png',
    ],
    shortDesc: '與新品GPS智慧手錶拍張照吧！',
  },
]

// badgeList.forEach(badge => {
//   const imgList = [
//     badge.icon,
//     badge.blackIcon,
//     badge.layout[0],
//     badge.layout[1],
//     badge.layout[2],
//     badge.layout_noLogo[0],
//     badge.layout_noLogo[1],
//     badge.layout_noLogo[2],
//   ]

//   imgList.forEach(src => {
//     const img = new Image()
//     img.src = src
//   })
// })

let dataList = []
const fragment = new DocumentFragment()
async function fetchData() {
  try {
    const response = await fetch('./pic.json')
    if (!response.ok) {
      throw new Error('Network response was not ok')
    }
    const data = await response.json()
    dataList = data
  } catch (error) {
    console.error('error', error)
  }
}

let selectedBadge = ''
let currentLayout = 'pageIndex'

document.addEventListener('DOMContentLoaded', async () => {
  await fetchData()
  const limit = 20
  dataList.forEach((data, index) => {
    const div = document.createElement('div')
    const img = document.createElement('img')
    img.src = data.pic
    div.classList.add('display-img')
    div.setAttribute('data-index', index)
    div.appendChild(img)
    div.addEventListener('click', openPhotoModal.bind(null, index))
    fragment.appendChild(div)
  })

  const pageIndex = document.getElementById('pageIndex')
  const pageBadge = document.getElementById('pageBadge')
  const pageLayout = document.getElementById('page-layout')
  const pageUploadImg = document.getElementById('page-uploadImg')
  const pageShared = document.getElementById('page-share')
  const pageForm = document.getElementById('pageForm')
  const pageWaterfall = document.getElementById('pageWaterfall')
  const couponTemplate = document.getElementById('coupon-template')
  const pageCoupon = document.getElementById('coupon-template')

  const mainContainer = document.querySelector('.main-container')
  const lookMore = document.getElementById('look-more')
  const indexBadgeTitle = document.getElementById('index-badge-title')
  const indexJoinBtn = document.getElementById('index-join-btn')
  const layoutChooseBtn = document.getElementById('layout-choose-btn')

  // 監聽首頁顯示 看更多
  if (mainContainer && indexBadgeTitle && lookMore) {
    console.log('window height', window.innerHeight)
    const titleBottom = indexBadgeTitle.getBoundingClientRect().bottom
    let needHideTitle = false

    if (window.innerHeight - titleBottom < 110) {
      lookMore.style.display = 'flex'
      indexBadgeTitle.style.visibility = 'hidden'
      needHideTitle = true
    }

    document.addEventListener('scroll', () => {
      if (needHideTitle) {
        if (window.scrollY > 0) {
          lookMore.style.display = 'none'
          indexBadgeTitle.style.visibility = 'visible'
        } else {
          lookMore.style.display = 'flex'
          indexBadgeTitle.style.visibility = 'hidden'
        }
      }
    })
  }

  // 監聽首頁參加活動按鈕
  if (indexJoinBtn) {
    indexJoinBtn.addEventListener('click', () => {
      if (pageIndex && pageBadge) {
        pageIndex.style.display = 'none'
        pageBadge.style.display = 'block'
        currentLayout = 'pageBadge'
        mainContainer.setAttribute('bg', 'mask')
      }
    })
  }

  const badge01Card = document.getElementById('badge01')
  const badge02Card = document.getElementById('badge02')
  const badge03Card = document.getElementById('badge03')
  const badge04Card = document.getElementById('badge04')
  const badge05Card = document.getElementById('badge05')
  const badge06Card = document.getElementById('badge06')
  const badge07Card = document.getElementById('badge07')
  const badge08Card = document.getElementById('badge08')
  const badge09Card = document.getElementById('badge09')
  const badge10Card = document.getElementById('badge10')
  const badge11Card = document.getElementById('badge11')
  const badge12Card = document.getElementById('badge12')

  if (badge01Card) {
    badge01Card.addEventListener('click', () => {
      appendSwiperSlides('badge01')
    })
  }

  if (badge02Card) {
    badge02Card.addEventListener('click', () => {
      appendSwiperSlides('badge02')
    })
  }

  if (badge03Card) {
    badge03Card.addEventListener('click', () => {
      appendSwiperSlides('badge03')
    })
  }

  if (badge04Card) {
    badge04Card.addEventListener('click', () => {
      appendSwiperSlides('badge04')
    })
  }

  if (badge05Card) {
    badge05Card.addEventListener('click', () => {
      appendSwiperSlides('badge05')
    })
  }

  if (badge06Card) {
    badge06Card.addEventListener('click', () => {
      appendSwiperSlides('badge06')
    })
  }

  if (badge07Card) {
    badge07Card.addEventListener('click', () => {
      appendSwiperSlides('badge07')
    })
  }

  if (badge08Card) {
    badge08Card.addEventListener('click', () => {
      appendSwiperSlides('badge08')
    })
  }

  if (badge09Card) {
    badge09Card.addEventListener('click', () => {
      appendSwiperSlides('badge09')
    })
  }

  if (badge10Card) {
    badge10Card.addEventListener('click', () => {
      appendSwiperSlides('badge10')
    })
  }

  if (badge11Card) {
    badge11Card.addEventListener('click', () => {
      appendSwiperSlides('badge11')
    })
  }

  if (badge12Card) {
    badge12Card.addEventListener('click', () => {
      appendSwiperSlides('badge12')
    })
  }

  let swiper
  let badgeObj
  function appendSwiperSlides(id) {
    selectedBadge = id
    badgeObj = badgeList.find(badge => badge.id === id)
    const swiperEl = document.querySelector('.swiper-wrapper')

    if (swiper) {
      swiper.removeAllSlides()
      swiper.init()
    }

    swiper = new Swiper('.layout-swiper', {
      slidesPerView: 1.3,
      centeredSlides: true,
      spaceBetween: 10,
      navigation: {
        nextEl: '.layout-swiper-next',
        prevEl: '.layout-swiper-prev',
      },
      on: {
        init() {
          const prevEl = document.querySelector('.layout-swiper-prev')

          if (prevEl) {
            prevEl.style.display = 'none'
          }
        },
        slideChange() {
          const prevEl = document.querySelector('.layout-swiper-prev')
          const nextEl = document.querySelector('.layout-swiper-next')

          if (this.activeIndex === 0) {
            prevEl.style.display = 'none'
          } else {
            prevEl.style.display = 'flex'
          }

          if (this.activeIndex === this.slides.length - 1) {
            nextEl.style.display = 'none'
          } else {
            nextEl.style.display = 'flex'
          }
        },
      },
    })

    for (let i = 0; i < badgeObj.layout.length; i++) {
      const slide = document.createElement('div')
      slide.classList.add('swiper-slide')

      const imgEl = document.createElement('img')
      imgEl.src = badgeObj.layout[i]

      slide.appendChild(imgEl)
      swiperEl.appendChild(slide)
    }

    if (pageBadge && pageLayout) {
      pageBadge.style.display = 'none'
      pageLayout.style.display = 'block'
      currentLayout = 'pageLayout'
    }
  }

  // 監聽選擇版型按鈕
  if (layoutChooseBtn) {
    layoutChooseBtn.addEventListener('click', () => {
      pageLayout.style.display = 'none'
      pageUploadImg.style.display = 'block'
      resetUploadImg()
      switch (swiper.activeIndex) {
        case 0:
          current_photo_grid = photo_grid_1
          photo_grid_1.style.display = 'block'
          setBgImg(photo_grid_1)
          break
        case 1:
          current_photo_grid = photo_grid_2
          photo_grid_2.style.display = 'block'
          setBgImg(photo_grid_2)
          break
        case 2:
          current_photo_grid = photo_grid_3
          photo_grid_3.style.display = 'block'
          setBgImg(photo_grid_3)
          break
        default:
          break
      }
      currentLayout = 'pageUploadImg'
    })
  }

  function resetUploadImg() {
    photo_grid_1.style.display = 'none'
    photo_grid_2.style.display = 'none'
    photo_grid_3.style.display = 'none'

    photo_grid_1.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
    photo_grid_2.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
    photo_grid_3.querySelectorAll('img').forEach(img => {
      img.src = ''
    })
  }

  // 繪製上傳相片的拍立得底圖
  function setBgImg(el) {
    const bgImgEl = el.querySelector('.bg-photo > img')
    const descContainer = document.getElementById('photo-short-desc')
    if (bgImgEl) {
      bgImgEl.src = badgeObj.layout[swiper.activeIndex]
    }

    if (descContainer) {
      descContainer.innerText = badgeObj.shortDesc
    }
  }

  // 處理上傳照片後，調整照片大小
  let current_photo_grid
  const photo_grid_1 = document.getElementById('photo-grid-1')
  const photo_grid_2 = document.getElementById('photo-grid-2')
  const photo_grid_3 = document.getElementById('photo-grid-3')

  const photo1 = document.getElementById('grid-1')
  const photo2Left = document.getElementById('grid-2-left')
  const photo2Right = document.getElementById('grid-2-right')
  const photo3Left = document.getElementById('grid-3-left')
  const photo3TopRight = document.getElementById('grid-3-top-right')
  const photo3BottomRight = document.getElementById('grid-3-bottom-right')

  let photo1Cropper
  let photo2LeftCropper
  let photo2RightCropper
  let photo3LeftCropper
  let photo3TopRightCropper
  let photo3BottomRightCropper

  if (photo1) {
    photo1.addEventListener('change', event => {
      cropImg(event, 'grid-1')
    })
  }

  if (photo2Left) {
    photo2Left.addEventListener('change', event => {
      cropImg(event, 'grid-2-left')
    })
  }

  if (photo2Right) {
    photo2Right.addEventListener('change', event => {
      cropImg(event, 'grid-2-right')
    })
  }

  if (photo3Left) {
    photo3Left.addEventListener('change', event => {
      cropImg(event, 'grid-3-left')
    })
  }

  if (photo3TopRight) {
    photo3TopRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-top-right')
    })
  }

  if (photo3BottomRight) {
    photo3BottomRight.addEventListener('change', event => {
      cropImg(event, 'grid-3-bottom-right')
    })
  }

  function cropImg(evt, id) {
    const image = document.getElementById(`${id}-img`)
    const cropperBtn = document.getElementById(`${id}-cropper-btn`)
    let parentEl
    if (image) {
      parentEl = image.parentElement
    }
    let elWidth
    let eiHeight
    if (parentEl) {
      elWidth = parentEl.getBoundingClientRect().width
      eiHeight = parentEl.getBoundingClientRect().height
    }

    const file = evt.target.files[0]
    const reader = new FileReader()

    reader.onload = function (e) {
      image.src = e.target.result
      console.log('try option4')
      const cropper = new Cropper(image, {
        // dragMode: 'move',
        autoCropArea: 1,
        checkOrientation: false,
        background: false,
        highlight: false,
        modal: false,
        cropBoxMovable: false,
        cropBoxResizable: false,
        minContainerWidth: elWidth,
        minContainerHeight: eiHeight,
        minCanvasWidth: elWidth,
        minCanvasHeight: eiHeight,
        minCropBoxWidth: elWidth,
        minCropBoxHeight: eiHeight,
        aspectRatio: elWidth / eiHeight,
        ready() {
          cropper.crop()
          cropper.setCanvasData(0, 0, elWidth, eiHeight)
          cropper.move(1, 0)
          cropper.move(-1, 0)
          cropper.zoom(0.1)
        },
      })

      if (id === 'grid-1') {
        photo1Cropper = cropper
      } else if (id === 'grid-2-left') {
        photo2LeftCropper = cropper
      } else if (id === 'grid-2-right') {
        photo2RightCropper = cropper
      } else if (id === 'grid-3-left') {
        photo3LeftCropper = cropper
      } else if (id === 'grid-3-top-right') {
        photo3TopRightCropper = cropper
      } else if (id === 'grid-3-bottom-right') {
        photo3BottomRightCropper = cropper
      }

      if (cropperBtn) {
        cropperBtn.addEventListener('click', () => {
          let croppedCanvas
          if (id === 'grid-1') {
            croppedCanvas = photo1Cropper.getCroppedCanvas()
          } else if (id === 'grid-2-left') {
            croppedCanvas = photo2LeftCropper.getCroppedCanvas()
          } else if (id === 'grid-2-right') {
            croppedCanvas = photo2RightCropper.getCroppedCanvas()
          } else if (id === 'grid-3-left') {
            croppedCanvas = photo3LeftCropper.getCroppedCanvas()
          } else if (id === 'grid-3-top-right') {
            croppedCanvas = photo3TopRightCropper.getCroppedCanvas()
          } else if (id === 'grid-3-bottom-right') {
            croppedCanvas = photo3BottomRightCropper.getCroppedCanvas()
          }

          const roundedCanvas = getCanvasImg(croppedCanvas)
          image.src = roundedCanvas.toDataURL()

          if (id === 'grid-1') {
            photo1Cropper.destroy()
          } else if (id === 'grid-2-left') {
            photo2LeftCropper.destroy()
          } else if (id === 'grid-2-right') {
            photo2RightCropper.destroy()
          } else if (id === 'grid-3-left') {
            photo3LeftCropper.destroy()
          } else if (id === 'grid-3-top-right') {
            photo3TopRightCropper.destroy()
          } else if (id === 'grid-3-bottom-right') {
            photo3BottomRightCropper.destroy()
          }
        })
      }
    }
    if (file) {
      reader.readAsDataURL(file)
    }
  }

  // 組合拍立得照片，並轉成base64
  const photoUploadBtn = document.getElementById('photo-upload-btn')
  let base64Url
  let base64Url_nologo
  if (photoUploadBtn) {
    photoUploadBtn.addEventListener('click', async () => {
      switch (swiper.activeIndex) {
        case 0:
          const btn = document.getElementById(`grid-1-cropper-btn`)
          btn.click()

          await new Promise(resolve => {
            const wait = setInterval(() => {
              clearInterval(wait)
              resolve()
            }, 100)
          })
          break
        case 1:
          document.getElementById('grid-2-left-cropper-btn').click()
          document.getElementById('grid-2-right-cropper-btn').click()
          await new Promise(resolve => {
            const wait = setInterval(() => {
              clearInterval(wait)
              resolve()
            }, 100)
          })

          break
        case 2:
          document.getElementById('grid-3-left-cropper-btn').click()
          document.getElementById('grid-3-top-right-cropper-btn').click()
          document.getElementById('grid-3-bottom-right-cropper-btn').click()
          await new Promise(resolve => {
            const wait = setInterval(() => {
              clearInterval(wait)
              resolve()
            }, 100)
          })
          break
        default:
          break
      }
      const bgImg = current_photo_grid.querySelector('.bg-photo > img')
      const canvas = document.createElement('canvas')
      const context = canvas.getContext('2d')
      const canvas2 = document.createElement('canvas')
      const cxt = canvas2.getContext('2d')
      const width = bgImg.getBoundingClientRect().width
      const height = bgImg.getBoundingClientRect().height
      canvas.width = width
      canvas.height = height
      canvas2.width = width
      canvas2.height = height
      context.imageSmoothingEnabled = true
      // 先畫拍立得底圖
      context.drawImage(bgImg, 0, 0, width, height)
      // 再找出拍立得上所有的 img
      const allImages = current_photo_grid.querySelectorAll('img')
      const filteredImages = Array.from(allImages).filter(img => {
        return !img.closest('.bg-photo')
      })
      filteredImages.forEach(img => {
        const xPos = img.getBoundingClientRect().x - bgImg.getBoundingClientRect().x
        const yPos = img.getBoundingClientRect().y - bgImg.getBoundingClientRect().y
        const _width = img.getBoundingClientRect().width
        const _height = img.getBoundingClientRect().height
        context.drawImage(img, xPos, yPos, _width, _height)
      })
      base64Url = canvas.toDataURL()

      const noLogoImg = document.createElement('img')
      noLogoImg.src = badgeObj.layout_noLogo[swiper.activeIndex]

      await new Promise(resolve => {
        let wait2 = setInterval(() => {
          clearInterval(wait2)
          resolve()
        }, 100)
      })

      // 先畫拍立得底圖
      cxt.drawImage(noLogoImg, 0, 0, width, height)
      filteredImages.forEach(img => {
        const xPos = img.getBoundingClientRect().x - bgImg.getBoundingClientRect().x
        const yPos = img.getBoundingClientRect().y - bgImg.getBoundingClientRect().y
        const _width = img.getBoundingClientRect().width
        const _height = img.getBoundingClientRect().height
        cxt.drawImage(img, xPos, yPos, _width, _height)
      })
      base64Url_nologo = canvas2.toDataURL()

      pageUploadImg.style.display = 'none'
      pageShared.style.display = 'block'
      document.getElementById('share-img').src = base64Url_nologo
      currentLayout = 'pageShared'
    })
  }

  // 是否填寫過資料
  let isDoneForm = false
  const shareBtn = document.getElementById('share-btn')
  if (shareBtn) {
    shareBtn.addEventListener('click', () => {
      badgeTaskDone()
      pageShared.style.display = 'none'
      if (isDoneForm) {
        pageIndex.style.display = 'block'
      } else {
        pageForm.style.display = 'block'
      }
      mainContainer.setAttribute('bg', 'right')
      currentLayout = 'pageForm'
    })
  }

  const submitFormBtn = document.getElementById('submit-form-btn')
  if (submitFormBtn) {
    submitFormBtn.addEventListener('click', () => {
      // 傳送資料
      // 假定已經填寫過資料
      isDoneForm = true
      pageForm.style.display = 'none'
      pageIndex.style.display = 'block'
    })
  }

  const photoModal = document.getElementById('photo-modal')
  // 監聽精彩直擊按鈕
  const waterfallBtn = document.getElementById('waterfall')
  if (waterfallBtn) {
    waterfallBtn.addEventListener('click', () => {
      pageIndex.style.display = 'none'
      pageWaterfall.style.display = 'block'
      currentLayout = 'pageWaterfall'
      mainContainer.setAttribute('bg', 'right')
      appendPhoto()
      if (photoModal) {
        photoModal.addEventListener('click', () => {
          photoModal.style.display = 'none'
        })
      }
      const bottomEl = document.getElementById('bottom-more')
      let needCallAgain = false
      const observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              needCallAgain = true
              if (entry.target === bottomEl) {
                appendPhoto()
                setTimeout(() => {
                  if (needCallAgain) {
                    appendPhoto()
                  }
                }, 500)
              }
            } else {
              needCallAgain = false
            }
          })
        },
        {
          rootMargin: '0px',
          threshold: 0,
        }
      )
      bottomEl && observer.observe(bottomEl)
    })
  }
  // 監聽精彩直擊頁面的立即參加按鈕
  const waterfallJoinBtn = document.getElementById('waterfall-join-btn')
  if (waterfallJoinBtn) {
    pageWaterfall.style.display = 'none'
    pageIndex.style.display = 'block'
  }
  const receiveBtn = document.getElementById('receive-btn')
  if (receiveBtn) {
    receiveBtn.addEventListener('click', () => {
      window.open('https://maac.io/2LRej')
      receiveBtn.style.display = 'none'
      showCouponBtn.style.display = 'flex'
    })
  }
  const showCouponBtn = document.getElementById('show-coupon-btn')
  if (showCouponBtn) {
    showCouponBtn.addEventListener('click', () => {
      console.log('hihi')
      if (couponTemplate) {
        couponTemplate.style.display = 'block'
        pageBadge.style.display = 'none'
        currentLayout = 'couponTemplate'
      }
    })
  }

  const couponExchangeBtn = document.getElementById('coupon-exchange-btn')
  const couponModal = document.getElementById('coupon-modal-template')

  if (couponExchangeBtn) {
    couponExchangeBtn.addEventListener('click', () => {
      if (couponModal) {
        couponModal.style.display = 'block'
      }
    })
  }

  const cancelCouponModalBtn = document.getElementById('coupon-modal-cancel')
  const couponModalExchange = document.getElementById('coupon-modal-exchange')

  const coupontModalInput = document.getElementById('coupon-modal-input')
  const bottleCoupon = document.getElementById('bottle-coupon')

  if (couponModalExchange) {
    couponModalExchange.addEventListener('click', () => {
      if (coupontModalInput.value) {
        couponModal.style.display = 'none'
        if (bottleCoupon) {
          bottleCoupon.classList.add('disabled')
        }
      }
    })
  }

  if (cancelCouponModalBtn) {
    cancelCouponModalBtn.addEventListener('click', () => {
      couponModal.style.display = 'none'
    })
  }

  const backBtn = document.getElementById('back-btn')
  backBtn.addEventListener('click', () => {
    console.log('click')
    if (currentLayout === 'pageBadge') {
      currentLayout = 'pageIndex'
      pageBadge.style.display = 'none'
      pageIndex.style.display = 'block'
    } else if (currentLayout === 'couponTemplate') {
      couponTemplate.style.display = 'none'
      pageBadge.style.display = 'block'
      currentLayout = 'pageBadge'
    } else if (currentLayout === 'pageLayout') {
      swiper.removeAllSlides()
      pageLayout.style.display = 'none'
      pageBadge.style.display = 'block'
      currentLayout = 'pageBadge'
    } else if (currentLayout === 'pageUploadImg') {
      pageUploadImg.style.display = 'none'
      pageLayout.style.display = 'block'
      currentLayout = 'pageLayout'
    } else if (currentLayout === 'pageShared') {
      pageShared.style.display = 'none'
      pageUploadImg.style.display = 'block'
      currentLayout = 'pageUploadImg'
    } else if (currentLayout === 'pageForm') {
      pageForm.style.display = 'none'
      pageShared.style.display = 'block'
      currentLayout = 'pageShared'
    } else if (currentLayout === 'pageWaterfall') {
      pageWaterfall.style.display = 'none'
      pageIndex.style.display = 'block'
      currentLayout = 'pageIndex'
    }
  })

  function appendPhoto() {
    const displayContainer = document.getElementById('display-container')
    const fragmentChildren = Array.from(fragment.childNodes)

    if (displayContainer && fragmentChildren.length) {
      const tmpFragment = new DocumentFragment()
      for (let i = 0; i < limit; i++) {
        if (fragmentChildren[i]) {
          tmpFragment.appendChild(fragmentChildren[i])
        }
      }
      displayContainer.appendChild(tmpFragment)
    }
  }

  function openPhotoModal(index, event) {
    const avatar = document.getElementById('user-avatar')
    const name = document.getElementById('user-name')
    const photo = document.getElementById('user-photo')

    if (avatar) {
      avatar.src = dataList[index].displaypic
    }

    if (name) {
      name.innerText = dataList[index].displayname
    }

    if (photo) {
      photo.src = dataList[index].pic
    }

    if (photoModal) {
      photoModal.style.display = 'flex'
    }
  }

  function getCanvasImg(sourceCanvas) {
    var canvas = document.createElement('canvas')
    var context = canvas.getContext('2d')
    var width = sourceCanvas.width
    var height = sourceCanvas.height

    canvas.width = width
    canvas.height = height
    context.imageSmoothingEnabled = true
    context.drawImage(sourceCanvas, 0, 0, width, height)
    return canvas
  }

  function badgeTaskDone() {
    const taskCard = document.getElementById(selectedBadge)
    if (taskCard) {
      taskCard.querySelector('img').src = badgeObj.icon
    }
  }
})
